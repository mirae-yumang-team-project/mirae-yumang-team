<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}">ê²Œì‹œê¸€ ìƒì„¸</title>
  <link rel="stylesheet" href="/static/css/reset.css">
  <link rel="stylesheet" href="/static/css/post-detail.css">
</head>
<body>
<div class="navbar">
  <a href="/home" class="navbar-brand">STARLOG</a>
    <div class="navbar-menu">
        <span th:if="${username}" style="color: white;" ></span>
        <a href="/posts">ê²Œì‹œíŒ</a>
        <a th:if="${username}" href="/mypage" th:text="${username} + 'ë‹˜'"></a>
        <a th:if="${username}" href="/auth/logout">ë¡œê·¸ì•„ì›ƒ</a>
        <a th:unless="${username}" href="/auth/login">ë¡œê·¸ì¸</a>
  </div>
</div>

<div class="container">
  <div class="post-footer">
      <!-- ì‘ì„±ìë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ -->
      <div class="btn-group" th:if="${isAuthor}">
        <a th:href="@{/posts/{id}/edit(id=${post.id})}" class="btn btn-primary">ìˆ˜ì •</a>
        <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" style="display: inline;"
              onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
          <button type="submit" class="btn btn-danger">ì‚­ì œ</button>
        </form>
      </div>
    </div>
  <div class="post-detail">
    <div class="post-header">
      <h1 class="post-title" th:text="${post.title}"></h1>
    <div class="post-meta">
        <span> ì‘ì„±ì: <span th:text="${post.author}"></span></span>
        <span> ì‘ì„±ì¼: <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span></span>
        <span> ì¡°íšŒìˆ˜: <span th:text="${post.viewCount}"></span></span>
      </div>
      
    </div>


    <div class="post-content">
    <div th:text="${post.content}" style="white-space: pre-wrap; margin-bottom: 30px;">ë³¸ë¬¸ ë‚´ìš©ì´ ì—¬ê¸°ì— ì¶œë ¥ë©ë‹ˆë‹¤.</div>

    <div class="post-image-container" th:if="${post.images != null and !post.images.empty}" 
      style="text-align: center; margin-bottom: 20px;">
      
      <div th:each="img : ${post.images}" style="margin-bottom: 15px;">
          <img th:src="${img.filePath}" 
              alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€"
              style="max-width: 100%; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
      </div>
  </div>
</div>

  <div class="recommend-wrapper">
    <div class="recommend-section">
            <button type="button" class="btn-like" 
                    th:classappend="${userChoice == 'L'} ? 'active' : ''"
                    th:onclick="'handleLikeHate(' + ${post.id} + ', \'L\')'">
                ì¶”ì²œ <span id="like-count" th:text="${likeCount}">0</span>
            </button>

            <button type="button" class="btn-hate"
                    th:classappend="${userChoice == 'H'} ? 'active' : ''" 
                    th:onclick="'handleLikeHate(' + ${post.id} + ', \'H\')'">
                ë¹„ì¶”ì²œ <span id="hate-count" th:text="${hateCount}">0</span>
            </button>
        </div>
    </div>
    
    <!-- <div class="comment-list">
      <h3>ëŒ“ê¸€ (<span th:text="${comments.size()}">0</span>)</h3>
      <div th:each="comment : ${comments}" class="comment-item">
          <strong th:text="${comment.user.username}">ì‘ì„±ì</strong>
          <span th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">ì‹œê°„</span>
          <p th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©</p>
          <hr>
      </div> -->
      <div class="comment-list">
        <h3>ëŒ“ê¸€ (<span th:text="${comments.size()}">0</span>)</h3>
        
        <div th:each="comment : ${comments}" th:if="${comment.parent == null}" class="comment-item">
            <strong th:text="${comment.user.username}">ì‘ì„±ì</strong>
            <span th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">ì‹œê°„</span>
            <p th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©</p>
            
            <button type="button" th:onclick="'toggleReplyForm(' + ${comment.id} + ')'" 
                    style="background:none; border:none; color:#C7D7F9; cursor:pointer; font-size:12px; padding:0;">[ë‹µê¸€ ë‹¬ê¸°]</button>

            <div th:id="'reply-form-' + ${comment.id}" style="display: none; margin: 10px 0 10px 20px;">
                <form th:action="@{/posts/{id}/comments(id=${post.id})}" method="post" onsubmit="return submitComment(event, this)">
                    <input type="hidden" name="parentId" th:value="${comment.id}">
                    <textarea name="content" style="width:80%; background:#1e1e1e; color:white; border:1px solid #333;" required></textarea>
                    <button type="submit">ë“±ë¡</button>
                </form>
            </div>

            <div th:each="child : ${comment.children}" class="reply-item" style="margin-left: 30px; margin-top: 10px; border-left: 2px solid #444; padding-left: 15px;">
                <span style="color: #888;">ã„´</span>
                <strong th:text="${child.user.username}">ì‘ì„±ì</strong>
                <span th:text="${#temporals.format(child.createdAt, 'yyyy-MM-dd HH:mm')}" style="font-size: 12px;">ì‹œê°„</span>
                <p th:text="${child.content}">ëŒ€ëŒ“ê¸€ ë‚´ìš©</p>
            </div>
            
            </div>
    </div>
  </div>
  <div class="comment-form">
      <form th:action="@{/posts/{id}/comments(id=${post.id})}" method="post" onsubmit="return submitComment(event, this)">
          <textarea name="content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
          <button type="submit">ëŒ“ê¸€ ë“±ë¡</button>
      </form>
  </div>
  <a href="/posts" class="btn btn-secondary">ëŒì•„ê°€ê¸°</a>

  </div>
</div>
<script>
  async function handleLikeHate(postId, type) {
    // 1. ì„œë²„ì— ìš”ì²­ ë³´ë‚´ê¸° (PostControllerì— ë§Œë“  API ì£¼ì†Œ)
    // URL êµ¬ì¡°: /posts/api/{postId}/like-hate?type=L ë˜ëŠ” H
    const url = `/posts/api/${postId}/like-hate?type=${type}`;
    
    console.log("ìš”ì²­ ì£¼ì†Œ:", url); // ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ì£¼ì†Œê°€ ë§ëŠ”ì§€ í™•ì¸ìš©
    
    try {
        const response = await fetch(url, {
            method: 'POST'
        });

        // 2. ë¡œê·¸ì¸ ì•ˆ ëœ ê²½ìš° ì²˜ë¦¬ (401 ì—ëŸ¬)
        if (response.status === 401) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
            window.location.href = "/auth/login";
            return;
        }

        // 3. ì„±ê³µ ì‹œ ë©”ì‹œì§€ ì¶œë ¥ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        if (response.ok) {
            location.reload(); // ìˆ«ìë¥¼ ì—…ë°ì´íŠ¸í•˜ê¸° ìœ„í•´ í™”ë©´ ìƒˆë¡œê³ ì¹¨
        } else {
            // ìƒì„¸ ì—ëŸ¬ íŒŒì•…ì„ ìœ„í•œ ë¡œê·¸
            console.error("Response Status:", response.status);
            if (response.status === 404) {
                alert("ì—ëŸ¬ 404: ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì»¨íŠ¸ë¡¤ëŸ¬ ë§¤í•‘ì„ í™•ì¸í•˜ì„¸ìš”.");
            } else if (response.status === 400) {
                alert("ì—ëŸ¬ 400: ë³´ë‚¸ ë°ì´í„°(type)ê°€ ì„œë²„ì˜ Enum í˜•ì‹ê³¼ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            } else if (response.status === 403) {
                alert("ì—ëŸ¬ 403: ë³´ì•ˆ(CSRF) ê¶Œí•œ ë¬¸ì œì…ë‹ˆë‹¤.");
            } else {
                alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½”ë“œ: " + response.status);
            }
        }
    } catch (error) {
        console.error("Error:", error);
        alert("ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
  }

  function toggleReplyForm(commentId) {
    const form = document.getElementById('reply-form-' + commentId);
    if (form.style.display === 'none') {
        form.style.display = 'block';
    } else {
        form.style.display = 'none';
    }
  }
  // ëŒ“ê¸€ ë¹„ë™ê¸° ë“±ë¡ í•¨ìˆ˜
  async function submitComment(event, form) {
      event.preventDefault(); // í˜ì´ì§€ ì´ë™ ë°©ì§€

      const formData = new FormData(form);
      const url = form.action; // formì˜ th:action ì£¼ì†Œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©

      try {
          const response = await fetch(url, {
              method: 'POST',
              body: formData,
          });

          // ğŸ’¡ ì„œë²„ì—ì„œ 401(ë¡œê·¸ì¸ ì•ˆë¨)ì„ ë³´ëƒˆì„ ë•Œ ì²˜ë¦¬
          if (response.status === 401) {
              alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
              window.location.href = "/auth/login"; // ë¡œê·¸ì¸ í˜ì´ì§€ ì£¼ì†Œ í™•ì¸!
              return;
          }

          if (response.ok) {
              const newComment = await response.json(); // ì„œë²„ì—ì„œ ì¤€ DTO ë°›ê¸°
              appendComment(newComment); // í™”ë©´ì— ì¦‰ì‹œ ì¶”ê°€
              form.querySelector('textarea').value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
              
              // ëŒ€ëŒ“ê¸€ í¼ì´ì—ˆìœ¼ë©´ ë‹¤ì‹œ ìˆ¨ê¸°ê¸°
              if (form.closest('[id^="reply-form-"]')) {
                  form.parentElement.style.display = 'none';
              }
          } else if (response.status === 401) {
              alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
              window.location.href = "/auth/login";
          }
      } catch (error) {
          console.error("Error:", error);
          alert("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
      return false;
  }

  // í™”ë©´ì— ìƒˆ ëŒ“ê¸€ HTMLì„ ê½‚ì•„ì£¼ëŠ” í•¨ìˆ˜
  function appendComment(comment) {
    // 1. ì´ í´ë˜ìŠ¤ ì´ë¦„(.comment-list)ì´ HTMLì˜ <div> í´ë˜ìŠ¤ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸!
    const commentList = document.querySelector('.comment-list');
    
    if (!commentList) {
        console.error("ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
        return;
    }

    if (comment.parentId) {
        // ëŒ€ëŒ“ê¸€ ë¡œì§...
        const parentForm = document.getElementById('reply-form-' + comment.parentId);
        // ë¶€ëª¨ í¼ì´ ìˆëŠ” ê°ì‹¸ëŠ” div(comment-item)ë¥¼ ì°¾ì•„ì„œ ê·¸ ëì— ì¶”ê°€
        parentForm.closest('.comment-item').insertAdjacentHTML('beforeend', `
            <div class="reply-item" style="margin-left: 30px; margin-top: 10px; border-left: 2px solid #444; padding-left: 15px;">
                <span style="color: #888;">ã„´</span>
                <strong>${comment.username}</strong>
                <span style="font-size: 12px;">ë°©ê¸ˆ ì „</span>
                <p>${comment.content}</p>
            </div>
        `);
    } else {
        // ì¼ë°˜ ëŒ“ê¸€ ë¡œì§: commentListì˜ ë§¨ ë’¤(beforeend)ì— ì¶”ê°€
        const commentHtml = `
            <div class="comment-item">
                <strong>${comment.username}</strong>
                <span style="font-size: 12px;">ë°©ê¸ˆ ì „</span>
                <p>${comment.content}</p>
                <button type="button" onclick="toggleReplyForm(${comment.id})" 
                        style="background:none; border:none; color:#C7D7F9; cursor:pointer; font-size:12px; padding:0;">[ë‹µê¸€ ë‹¬ê¸°]</button>
                <div id="reply-form-${comment.id}" style="display: none; margin: 10px 0 10px 20px;">
                    <form action="/posts/${window.location.pathname.split('/').pop()}/comments" method="post" onsubmit="return submitComment(event, this)">
                        <input type="hidden" name="parentId" value="${comment.id}">
                        <textarea name="content" style="width:80%; background:#1e1e1e; color:white; border:1px solid #333;" required></textarea>
                        <button type="submit">ë“±ë¡</button>
                    </form>
                </div>
            </div>
        `;
        commentList.insertAdjacentHTML('beforeend', commentHtml);
    }
      
      // ëŒ“ê¸€ ìˆ˜ ìˆ«ì ì—…ë°ì´íŠ¸ (ì„ íƒ ì‚¬í•­)
      const countSpan = document.querySelector('.comment-list h3 span');
      if(countSpan) countSpan.innerText = parseInt(countSpan.innerText) + 1;
  }
</script>
</body>
</html>