<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}">게시글 상세</title>
  <link rel="stylesheet" href="/static/css/reset.css">
  <link rel="stylesheet" href="/static/css/post-detail.css">
</head>
<body>
<div class="navbar">
  <a href="/home" class="navbar-brand">STARLOG</a>
    <div class="navbar-menu">
        <span th:if="${username}" style="color: white;" ></span>
        <a href="/posts">게시판</a>
        <a th:if="${username}" href="/mypage" th:text="${username} + '님'"></a>
        <a th:if="${username}" href="/auth/logout">로그아웃</a>
        <a th:unless="${username}" href="/auth/login">로그인</a>
  </div>
</div>

<div class="container">
  <div class="post-footer">
      <!-- 작성자만 수정/삭제 버튼 표시 -->
      <div class="btn-group" th:if="${isAuthor}">
        <a th:href="@{/posts/{id}/edit(id=${post.id})}" class="btn btn-primary">수정</a>
        <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" style="display: inline;"
              onsubmit="return confirm('정말 삭제하시겠습니까?');">
          <button type="submit" class="btn btn-danger">삭제</button>
        </form>
      </div>
    </div>
  <div class="post-detail">
    <div class="post-header">
      <h1 class="post-title" th:text="${post.title}"></h1>
    <div class="post-meta">
        <span> 작성자: <span th:text="${post.author}"></span></span>
        <span> 작성일: <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span></span>
        <span> 조회수: <span th:text="${post.viewCount}"></span></span>
      </div>
      
    </div>


    <div class="post-content">
    <div th:text="${post.content}" style="white-space: pre-wrap;">본문 내용이 여기에 출력됩니다.</div>

    <div class="post-image" th:if="${post.filePath}" style="text-align: center; margin-bottom: 20px;">
        <img th:src="${post.filePath}" alt="첨부 이미지" 
             style="max-width: 100%; border-radius: 10px;">
    </div>
</div>

  <div class="recommend-wrapper">
    <div class="recommend-section">
            <button type="button" class="btn-like" 
                    th:classappend="${userChoice == 'L'} ? 'active' : ''"
                    th:onclick="'handleLikeHate(' + ${post.id} + ', \'L\')'">
                추천 <span id="like-count" th:text="${likeCount}">0</span>
            </button>

            <button type="button" class="btn-hate"
                    th:classappend="${userChoice == 'H'} ? 'active' : ''" 
                    th:onclick="'handleLikeHate(' + ${post.id} + ', \'H\')'">
                비추천 <span id="hate-count" th:text="${hateCount}">0</span>
            </button>
        </div>
    </div>
    
    <div class="comment-list">
      <h3>댓글 (<span th:text="${comments.size()}">0</span>)</h3>
      <div th:each="comment : ${comments}" class="comment-item">
          <strong th:text="${comment.user.username}">작성자</strong>
          <span th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">시간</span>
          <p th:text="${comment.content}">댓글 내용</p>
          <hr>
      </div>
  </div>
    <div class="comment-form">
      <form th:action="@{/posts/{id}/comments(id=${post.id})}" method="post">
          <textarea name="content" placeholder="댓글을 입력하세요" required></textarea>
          <button type="submit">댓글 등록</button>
      </form>
  </div>
  <a href="/posts" class="btn btn-secondary">돌아가기</a>

  </div>
</div>
<script>
  async function handleLikeHate(postId, type) {
    // 1. 서버에 요청 보내기 (PostController에 만든 API 주소)
    // URL 구조: /posts/api/{postId}/like-hate?type=L 또는 H
    const url = `/posts/api/${postId}/like-hate?type=${type}`;
    
    console.log("요청 주소:", url); // 브라우저 콘솔(F12)에서 주소가 맞는지 확인용
    
    try {
        const response = await fetch(url, {
            method: 'POST'
        });

        // 2. 로그인 안 된 경우 처리 (401 에러)
        if (response.status === 401) {
            alert("로그인이 필요한 서비스입니다.");
            window.location.href = "/auth/login";
            return;
        }

        // 3. 성공 시 메시지 출력 후 페이지 새로고침
        if (response.ok) {
            location.reload(); // 숫자를 업데이트하기 위해 화면 새로고침
        } else {
            // 상세 에러 파악을 위한 로그
            console.error("Response Status:", response.status);
            if (response.status === 404) {
                alert("에러 404: 주소를 찾을 수 없습니다. 컨트롤러 매핑을 확인하세요.");
            } else if (response.status === 400) {
                alert("에러 400: 보낸 데이터(type)가 서버의 Enum 형식과 맞지 않습니다.");
            } else if (response.status === 403) {
                alert("에러 403: 보안(CSRF) 권한 문제입니다.");
            } else {
                alert("처리 중 오류가 발생했습니다. 코드: " + response.status);
            }
        }
    } catch (error) {
        console.error("Error:", error);
        alert("서버와 통신할 수 없습니다.");
    }
  }
</script>
</body>
</html>